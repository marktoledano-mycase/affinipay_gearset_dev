<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>56.0</apiVersion>
    <assignments>
        <name>Assign_Account_to_Billing_Account</name>
        <label>Assign Account to Billing Account</label>
        <locationX>792</locationX>
        <locationY>130</locationY>
        <assignmentItems>
            <assignToReference>Billing_Account.Account__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.ConvertedAccountId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Billing_Account</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Assigns lead&#39;s account and contact to product environment</description>
        <name>Assign_Product_Environment_Relationships</name>
        <label>Assign Product Environment Relationships</label>
        <locationX>644</locationX>
        <locationY>682</locationY>
        <assignmentItems>
            <assignToReference>get_ProductEnvironment.Account__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.ConvertedAccountId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>get_ProductEnvironment.Contact__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.ConvertedContactId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Product_Environment</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Sales_Conversion_to_Subscription</name>
        <label>Assign Sales Conversion to Subscription</label>
        <locationX>1411</locationX>
        <locationY>116</locationY>
        <assignmentItems>
            <assignToReference>Billing_Subscription.Sales_Lead_Conversion__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Subscription</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Billing_Subscription_Check</name>
        <label>Billing Subscription Check</label>
        <locationX>1215</locationX>
        <locationY>118</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Has_Subscription</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Billing_Subscription</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Sales_Conversion_to_Subscription</targetReference>
            </connector>
            <label>Has Subscription</label>
        </rules>
    </decisions>
    <decisions>
        <name>Bypass_Flow_Eval</name>
        <label>Bypass Flow Eval</label>
        <locationX>198</locationX>
        <locationY>464</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Execute</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Permission.RingLead_Merge_Bypass_Flows</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>get_ProductEnvironment</targetReference>
            </connector>
            <label>Execute</label>
        </rules>
    </decisions>
    <decisions>
        <name>dec_CheckOpportunity</name>
        <label>Check Opportunity</label>
        <locationX>1414</locationX>
        <locationY>683</locationY>
        <defaultConnector>
            <targetReference>Billing_Account</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>out_CheckOpportunity</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Converted_Opportunity</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Opportunity</targetReference>
            </connector>
            <label>True</label>
        </rules>
    </decisions>
    <decisions>
        <name>dec_HasProductEnvironment</name>
        <label>Has Product Environment?</label>
        <locationX>419</locationX>
        <locationY>683</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>out_HasProductEnvironment</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>get_ProductEnvironment</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Product_Environment_Relationships</targetReference>
            </connector>
            <label>True</label>
        </rules>
    </decisions>
    <decisions>
        <name>dec_LeadHasOpportunity</name>
        <label>Lead Has Opportunity</label>
        <locationX>827</locationX>
        <locationY>518</locationY>
        <defaultConnector>
            <targetReference>Billing_Account</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>out_LeadHasOpportunity</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.ConvertedOpportunityId</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Converted_Opportunity</targetReference>
            </connector>
            <label>True</label>
        </rules>
    </decisions>
    <decisions>
        <name>Has_Billing_Account</name>
        <label>Has Billing Account</label>
        <locationX>786</locationX>
        <locationY>344</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Billing_Account_Needs_Salesforce_Account</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Billing_Account</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Account_to_Billing_Account</targetReference>
            </connector>
            <label>Billing Account Needs Salesforce Account</label>
        </rules>
    </decisions>
    <description>After lead conversion checks to see if lead has an associated product environment and assigns account and contact to that product environment and relates the product environment to the converted lead&#39;s opportunity if there is one</description>
    <environments>Default</environments>
    <interviewLabel>Lead: Converted Lead Assign Converted Objects to PE {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Lead: Converted Lead Assign Converted Objects to PE</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Billing_Account</name>
        <label>Billing Account</label>
        <locationX>1018</locationX>
        <locationY>369</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Has_Billing_Account</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Firm_ID__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>get_ProductEnvironment.Firm_ID__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Account__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Billing_Account__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Billing_Subscription</name>
        <label>Billing Subscription</label>
        <locationX>1073</locationX>
        <locationY>116</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Billing_Subscription_Check</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Billing_Account__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Billing_Account.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Sales_Lead_Conversion__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Subscription_Start_Date__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>$Flow.CurrentDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>Billing_System__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Zuora-MC</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Billing_Subscription__c</object>
        <sortField>CreatedDate</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Converted_Opportunity</name>
        <label>Get Converted Opportunity</label>
        <locationX>1079</locationX>
        <locationY>730</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>dec_CheckOpportunity</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.ConvertedOpportunityId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Product_Environment__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Record_Type_Name__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>MyCase</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Checks to see if lead is related to a product environment</description>
        <name>get_ProductEnvironment</name>
        <label>Get Product Environment</label>
        <locationX>427</locationX>
        <locationY>461</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>dec_HasProductEnvironment</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Lead__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Brand__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>MyCase</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Product_Environment__c</object>
        <sortField>CreatedDate</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Billing_Account</name>
        <label>Update Billing Account</label>
        <locationX>935</locationX>
        <locationY>127</locationY>
        <connector>
            <targetReference>Billing_Subscription</targetReference>
        </connector>
        <inputReference>Billing_Account</inputReference>
    </recordUpdates>
    <recordUpdates>
        <description>Updates Opportunity with Product Environment</description>
        <name>Update_Opportunity</name>
        <label>Update Opportunity</label>
        <locationX>1415</locationX>
        <locationY>311</locationY>
        <connector>
            <targetReference>Billing_Account</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.ConvertedOpportunityId</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Product_Environment__c</field>
            <value>
                <elementReference>get_ProductEnvironment.Id</elementReference>
            </value>
        </inputAssignments>
        <object>Opportunity</object>
    </recordUpdates>
    <recordUpdates>
        <description>updates product environment with lead&#39;s account and contact</description>
        <name>Update_Product_Environment</name>
        <label>Update Product Environment</label>
        <locationX>832</locationX>
        <locationY>682</locationY>
        <connector>
            <targetReference>dec_LeadHasOpportunity</targetReference>
        </connector>
        <inputReference>get_ProductEnvironment</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Subscription</name>
        <label>Update Subscription</label>
        <locationX>1553</locationX>
        <locationY>116</locationY>
        <inputReference>Billing_Subscription</inputReference>
    </recordUpdates>
    <start>
        <locationX>79</locationX>
        <locationY>49</locationY>
        <connector>
            <targetReference>Bypass_Flow_Eval</targetReference>
        </connector>
        <filterFormula>{!$Record.Bypass_VR_and_Automation__c} = FALSE &amp;&amp;
ISCHANGED({!$Record.IsConverted}) &amp;&amp;
{!$Record.IsConverted} = TRUE</filterFormula>
        <object>Lead</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
</Flow>
