<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>57.0</apiVersion>
    <assignments>
        <name>Assign_Charge</name>
        <label>Assign Charge</label>
        <locationX>1318</locationX>
        <locationY>823</locationY>
        <assignmentItems>
            <assignToReference>varNewContractSKU.Subscription_Charge__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>New_Charge.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewContractSKU.SKU_Product__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>New_SKU_Product.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Create_Contract_SKU</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_New_Change_Plan_Transaction</name>
        <label>Assign New Change Plan Transaction</label>
        <locationX>986</locationX>
        <locationY>823</locationY>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Contract_SKU__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varNewContractSKU.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.History_Type__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Add</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Quantity_Type__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>f_QuantityType</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Quantity__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>New_Charge.Quantity__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Effective_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>f_TransactionEffectiveDate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Create_Transaction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_New_Contract_SKU</name>
        <label>Assign New Contract SKU</label>
        <locationX>1151</locationX>
        <locationY>450</locationY>
        <assignmentItems>
            <assignToReference>varNewContractSKU.Subscription_Contract__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Subscription_Contract__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewContractSKU.Effective_Start_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>f_TransactionEffectiveDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varNewContractSKU.Original_Opportunity_SKU__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Opportunity_SKU__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Charge_Check</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Update_Transaction</name>
        <label>Assign Update Transaction</label>
        <locationX>505</locationX>
        <locationY>550</locationY>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Contract_SKU__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Effective_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>f_TransactionEffectiveDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Quantity__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Quantity_Change__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.History_Type__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Update</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varContactSKU_transaction.Quantity_Type__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>f_QuantityType</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Create_Transaction</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Change_Type</name>
        <label>Change Type</label>
        <locationX>843</locationX>
        <locationY>455</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>New_Plan</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Update_SKU_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Plan Change</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>New_Charge</targetReference>
            </connector>
            <label>New Plan</label>
        </rules>
    </decisions>
    <decisions>
        <name>Charge_Check</name>
        <label>Charge Check</label>
        <locationX>1142</locationX>
        <locationY>605</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Charge_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>New_Charge</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>New_SKU_Product</targetReference>
            </connector>
            <label>Charge Found</label>
        </rules>
    </decisions>
    <decisions>
        <name>Update_Type</name>
        <label>Update Type</label>
        <locationX>499</locationX>
        <locationY>308</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Quantity_Update</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Update_SKU_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Quantity</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Update_Transaction</targetReference>
            </connector>
            <label>Quantity Update</label>
        </rules>
        <rules>
            <name>Plan_Change</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Update_SKU_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Plan Change</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Update_SKU_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Remove Plan</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Remove_Plan_Transaction</targetReference>
            </connector>
            <label>Plan Change</label>
        </rules>
    </decisions>
    <description>Runs daily at midnight to create contract sku transactions when updates are made from the billing system</description>
    <environments>Default</environments>
    <formulas>
        <name>f_CurrentQuantity</name>
        <dataType>Number</dataType>
        <expression>CASE( {!$Record.SKU_Product__r.Product_Type__c}, &quot;Main&quot;,
 {!$Record.User_Count_Rollup__c}, {!$Record.Add_On_Users__c} )</expression>
        <scale>0</scale>
    </formulas>
    <formulas>
        <name>f_FirmID</name>
        <dataType>String</dataType>
        <expression>{!$Record.Subscription_Charge__r.Firm_ID__c}</expression>
    </formulas>
    <formulas>
        <name>f_QuantityType</name>
        <dataType>String</dataType>
        <expression>CASE( {!$Record.SKU_Product__r.Product_Type__c}, &quot;Main&quot;, &quot;Users&quot;, &quot;Units&quot; )</expression>
    </formulas>
    <formulas>
        <name>f_TransactionEffectiveDate</name>
        <dataType>Date</dataType>
        <expression>IF( {!$Record.Update_SKU_Type__c} = &quot;Quantity&quot;, 
CASE( {!$Record.Pricing_Type__c}, &quot;Monthly&quot;, 
{!$Flow.CurrentDate} - 1, 
IF( AND( {!$Record.Quantity_Change__c} &lt; 0, NOT( ISBLANK( {!$Record.Subscription_Charge__c} ))),
{!$Record.Subscription_Charge__r.Effective_Start_Date__c}, 
{!$Flow.CurrentDate} - 1)),
{!$Flow.CurrentDate} - 1
)</expression>
    </formulas>
    <interviewLabel>Scheduler: Contract SKU Update Transactions {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Scheduler: Contract SKU Update Transactions</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>Create_Contract_SKU</name>
        <label>Create Contract SKU</label>
        <locationX>1168</locationX>
        <locationY>823</locationY>
        <connector>
            <targetReference>Assign_New_Change_Plan_Transaction</targetReference>
        </connector>
        <inputReference>varNewContractSKU</inputReference>
    </recordCreates>
    <recordCreates>
        <name>Create_Transaction</name>
        <label>Create Transaction</label>
        <locationX>505</locationX>
        <locationY>823</locationY>
        <inputReference>varContactSKU_transaction</inputReference>
    </recordCreates>
    <recordLookups>
        <name>New_Charge</name>
        <label>New Charge</label>
        <locationX>1019</locationX>
        <locationY>450</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_New_Contract_SKU</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Billing_Plan__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Firm_ID__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Subscription_Contract__r.Firm_ID__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Zuora_Effective_End_Date__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Quantity__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </filters>
        <filters>
            <field>Price__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </filters>
        <filters>
            <field>Pricing_Type__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Recurring</stringValue>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Accounting User License</stringValue>
            </value>
        </filters>
        <filters>
            <field>Billing_Subscription__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Subscription_Charge__r.Billing_Subscription__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Website Management Fee</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Billing_Subscription_Product_Charge__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>New_SKU_Product</name>
        <label>New SKU Product</label>
        <locationX>1318</locationX>
        <locationY>600</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_Charge</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Billing_Plan__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>New_Charge.Billing_Plan__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>SKU_Product__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Contract_SKU</name>
        <label>Update Contract SKU</label>
        <locationX>852</locationX>
        <locationY>309</locationY>
        <connector>
            <targetReference>Change_Type</targetReference>
        </connector>
        <inputAssignments>
            <field>Effective_End_Date__c</field>
            <value>
                <elementReference>f_TransactionEffectiveDate</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>381</locationX>
        <locationY>29</locationY>
        <connector>
            <targetReference>Update_Type</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Update_SKU__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Subscription_Charge__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Subscription_Charge_Status__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Active</stringValue>
            </value>
        </filters>
        <filters>
            <field>Update_SKU_Type__c</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Skip</stringValue>
            </value>
        </filters>
        <object>Contract_SKU__c</object>
        <schedule>
            <frequency>Daily</frequency>
            <startDate>2023-07-01</startDate>
            <startTime>00:00:00.000Z</startTime>
        </schedule>
        <triggerType>Scheduled</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <name>Remove_Plan_Transaction</name>
        <label>Remove Plan Transaction</label>
        <locationX>718</locationX>
        <locationY>309</locationY>
        <connector>
            <targetReference>Update_Contract_SKU</targetReference>
        </connector>
        <flowName>Function_Create_Contract_SKU_Transaction</flowName>
        <inputAssignments>
            <name>input_ChangeType</name>
            <value>
                <stringValue>Remove</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>input_CurrentQuantity</name>
            <value>
                <elementReference>f_CurrentQuantity</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>input_EffectiveDate</name>
            <value>
                <elementReference>f_TransactionEffectiveDate</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>input_NewQuantity</name>
            <value>
                <elementReference>f_CurrentQuantity</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>input_QuantityType</name>
            <value>
                <elementReference>f_QuantityType</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>varContractSKU_Id</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </subflows>
    <textTemplates>
        <name>query_ActiveRatePlan</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>SELECT Id FROM Billing_Subscription_Product_Charge__c 
WHERE Firm_ID__c = &#39;{!$Record.Subscription_Charge__r.Firm_ID__c}&#39; 
AND {!$Record.Subscription_Charge__r.Billing_Subscription__r.Status__c} = &#39;Active&#39; 
AND Billing_Plan__c IN (SELECT Billing_Plan__c FROM SKU_Product__c WHERE Product_Type__c = &#39;Main&#39; AND Product_Sub_Family__c = &#39;MyCase&#39;) 
AND Zuora_Effective_End_Date__c = null</text>
    </textTemplates>
    <variables>
        <name>varContactSKU_transaction</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Contract_SKU_Transaction__c</objectType>
    </variables>
    <variables>
        <name>varNewContractSKU</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Contract_SKU__c</objectType>
    </variables>
</Flow>
