<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>57.0</apiVersion>
    <assignments>
        <name>Assign_Account</name>
        <label>Assign Account</label>
        <locationX>1532</locationX>
        <locationY>269</locationY>
        <assignmentItems>
            <assignToReference>Product_Environment.Account__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varOpportunityUpdate.AccountId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Product_Environment_Dates</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Active_Opportunity</name>
        <label>Assign Active Opportunity</label>
        <locationX>755</locationX>
        <locationY>241</locationY>
        <assignmentItems>
            <assignToReference>varOpportunityUpdate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Active_Opportunity</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Product_Env_Check</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Conversion_Date</name>
        <label>Assign Conversion Date</label>
        <locationX>1061</locationX>
        <locationY>446</locationY>
        <assignmentItems>
            <assignToReference>Product_Environment.Conversion_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Flow.CurrentDate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Product_Environment_Account_Check</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_First_Purchase</name>
        <label>Assign First Purchase</label>
        <locationX>1053</locationX>
        <locationY>319</locationY>
        <assignmentItems>
            <assignToReference>Product_Environment.Conversion_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Flow.CurrentDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>Product_Environment.First_Purchase_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Flow.CurrentDate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Product_Environment_Account_Check</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Opportunity_Values</name>
        <label>Assign Opportunity Values</label>
        <locationX>1059</locationX>
        <locationY>766</locationY>
        <assignmentItems>
            <assignToReference>varOpportunityUpdate.StageName</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>f_StageName</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varOpportunityUpdate.Billing_Subscription__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varBillingSubscription.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varOpportunityUpdate.Product_Environment__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Product_Environment.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varOpportunityUpdate.CloseDate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>f_OpportunityCloseDate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Has_SKUs_Check</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Reactivated_Opportunity</name>
        <label>Assign Reactivated Opportunity</label>
        <locationX>755</locationX>
        <locationY>621</locationY>
        <assignmentItems>
            <assignToReference>varOpportunityUpdate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Reactivation_Opportunity</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Opportunity_Check</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Charges_Check</name>
        <label>Charges Check</label>
        <locationX>1392</locationX>
        <locationY>941</locationY>
        <defaultConnector>
            <targetReference>Update_Opportunity</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Charges_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Subscription_Charges</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Loop_Charges</targetReference>
            </connector>
            <label>Charges Found</label>
        </rules>
    </decisions>
    <decisions>
        <name>Firm_ID_Check</name>
        <label>Firm ID Check</label>
        <locationX>215</locationX>
        <locationY>278</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Firm_ID_Populated</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>input_FirmID</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Product_Environment</targetReference>
            </connector>
            <label>Firm ID Populated</label>
        </rules>
    </decisions>
    <decisions>
        <name>Has_SKUs_Check</name>
        <label>Has SKUs Check</label>
        <locationX>1234</locationX>
        <locationY>768</locationY>
        <defaultConnector>
            <targetReference>Update_Opportunity</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Missing_SKUs</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varOpportunityUpdate.Opportunity_SKU_License_Count__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>input_FirstTimeCharge</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Subscription_Charges</targetReference>
            </connector>
            <label>Missing SKUs</label>
        </rules>
    </decisions>
    <decisions>
        <name>Opportunity_Check</name>
        <label>Opportunity Check</label>
        <locationX>1047</locationX>
        <locationY>616</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Opportunity_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varOpportunityUpdate</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Opportunity_Values</targetReference>
            </connector>
            <label>Opportunity Found</label>
        </rules>
    </decisions>
    <decisions>
        <name>Product_Env_Check</name>
        <label>Product Env Check</label>
        <locationX>747</locationX>
        <locationY>443</locationY>
        <defaultConnector>
            <targetReference>Opportunity_Check</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>First_Purchase</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>input_FirstTimeCharge</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Product_Environment</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_First_Purchase</targetReference>
            </connector>
            <label>First Purchase</label>
        </rules>
        <rules>
            <name>Converted</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>input_FirstTimeCharge</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Product_Environment</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Conversion_Date</targetReference>
            </connector>
            <label>Converted</label>
        </rules>
    </decisions>
    <decisions>
        <name>Product_Environment_Account_Check</name>
        <label>Product Environment Account Check</label>
        <locationX>1251</locationX>
        <locationY>328</locationY>
        <defaultConnector>
            <targetReference>Update_Product_Environment_Dates</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Account_Not_Populated</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Product_Environment.Account__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Product_Environment</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>varOpportunityUpdate</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Account</targetReference>
            </connector>
            <label>Account Not Populated</label>
        </rules>
    </decisions>
    <decisions>
        <name>Subscription_Type_Check</name>
        <label>Subscription Type Check</label>
        <locationX>387</locationX>
        <locationY>445</locationY>
        <defaultConnector>
            <targetReference>Active_Opportunity</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Reactivation</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varBillingSubscription.Subscription_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Reactivation</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Reactivation_Opportunity</targetReference>
            </connector>
            <label>Reactivation</label>
        </rules>
    </decisions>
    <description>Called from new or updated Billing Subscription to evaluate what updates need to be made to Opportunity or Product Environment</description>
    <environments>Default</environments>
    <formulas>
        <name>f_ExistingBusinessOrReturningCustomer</name>
        <dataType>String</dataType>
        <expression>CASE( {!varBillingSubscription.Product_Tier__c},
&quot;lawpay_pro&quot;, &quot;Existing Business&quot;, 
&quot;Returning Customer&quot;)</expression>
    </formulas>
    <formulas>
        <name>f_MinCloseDate</name>
        <dataType>Date</dataType>
        <expression>ADDMONTHS( {!$Flow.CurrentDate}, -1)</expression>
    </formulas>
    <formulas>
        <description>Sets Close Date on Opportunity to Subscription Start Date if stage is being moved to Approvals</description>
        <name>f_OpportunityCloseDate</name>
        <dataType>Date</dataType>
        <expression>IF( {!input_FirstTimeCharge}, 
{!varOpportunityUpdate.CloseDate},
{!varBillingSubscription.Subscription_Start_Date__c} )</expression>
    </formulas>
    <formulas>
        <name>f_OpportunityRecordTypeName</name>
        <dataType>String</dataType>
        <expression>CASE( {!varBillingSubscription.Product_Tier__c}, 
&quot;lawpay_pro&quot;, &quot;LawPay Software&quot;, 
&quot;MyCase&quot;)</expression>
    </formulas>
    <formulas>
        <name>f_StageName</name>
        <dataType>String</dataType>
        <expression>IF( {!input_FirstTimeCharge}, &quot;Closed Won&quot;, &quot;Approvals&quot;)</expression>
    </formulas>
    <interviewLabel>Autolaunched: Billing Subscription Opportunity Update Evaluation {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Autolaunched: Billing Subscription Opportunity Update Evaluation</label>
    <loops>
        <name>Loop_Charges</name>
        <label>Loop Charges</label>
        <locationX>1565</locationX>
        <locationY>938</locationY>
        <collectionReference>Subscription_Charges</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Create_Opportunity_SKUs</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_Opportunity</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <description>Close Date greater or equal to this month</description>
        <name>Active_Opportunity</name>
        <label>Active Opportunity</label>
        <locationX>567</locationX>
        <locationY>241</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_Active_Opportunity</targetReference>
        </connector>
        <filterLogic>1 AND 2 AND 3 AND 4 AND (5 OR 6)</filterLogic>
        <filters>
            <field>Record_Type_Name__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>f_OpportunityRecordTypeName</elementReference>
            </value>
        </filters>
        <filters>
            <field>IsClosed</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Firm_ID__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>input_FirmID</elementReference>
            </value>
        </filters>
        <filters>
            <field>CloseDate</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>f_MinCloseDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>New Business</stringValue>
            </value>
        </filters>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Cross-Sell</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <sortField>CloseDate</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Product_Environment</name>
        <label>Product Environment</label>
        <locationX>395</locationX>
        <locationY>284</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Subscription_Type_Check</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Firm_ID__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>input_FirmID</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Product_Environment__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Close Date greater or equal to this month</description>
        <name>Reactivation_Opportunity</name>
        <label>Reactivation Opportunity</label>
        <locationX>561</locationX>
        <locationY>621</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_Reactivated_Opportunity</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Record_Type_Name__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>f_OpportunityRecordTypeName</elementReference>
            </value>
        </filters>
        <filters>
            <field>IsClosed</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Firm_ID__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>input_FirmID</elementReference>
            </value>
        </filters>
        <filters>
            <field>CloseDate</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>f_MinCloseDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Reactivated</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <sortField>CloseDate</sortField>
        <sortOrder>Asc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Subscription_Charges</name>
        <label>Subscription Charges</label>
        <locationX>1241</locationX>
        <locationY>939</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Charges_Check</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Billing_Subscription__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>varBillingSubscription.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Quantity__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </filters>
        <filters>
            <field>Price__c</field>
            <operator>GreaterThan</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </filters>
        <filters>
            <field>Billing_Plan__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Zuora_Effective_End_Date__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Billing_Subscription_Product_Charge__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Opportunity</name>
        <label>Update Opportunity</label>
        <locationX>1547</locationX>
        <locationY>631</locationY>
        <inputReference>varOpportunityUpdate</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Product_Environment_Dates</name>
        <label>Update Product Environment Dates</label>
        <locationX>1532</locationX>
        <locationY>436</locationY>
        <connector>
            <targetReference>Opportunity_Check</targetReference>
        </connector>
        <inputReference>Product_Environment</inputReference>
    </recordUpdates>
    <runInMode>SystemModeWithoutSharing</runInMode>
    <start>
        <locationX>97</locationX>
        <locationY>53</locationY>
        <connector>
            <targetReference>Firm_ID_Check</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <subflows>
        <name>Create_Opportunity_SKUs</name>
        <label>Create Opportunity SKUs</label>
        <locationX>1804</locationX>
        <locationY>938</locationY>
        <connector>
            <targetReference>Loop_Charges</targetReference>
        </connector>
        <flowName>Function_Create_Opportunity_SKU_Software</flowName>
        <inputAssignments>
            <name>input_BillingPlanId</name>
            <value>
                <elementReference>Loop_Charges.Billing_Plan__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>input_OpportunityId</name>
            <value>
                <elementReference>varOpportunityUpdate.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>input_Quantity</name>
            <value>
                <elementReference>Loop_Charges.Quantity__c</elementReference>
            </value>
        </inputAssignments>
    </subflows>
    <variables>
        <name>input_FirmID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>input_FirstTimeCharge</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>input_TriggeredOnCreate</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>varBillingSubscription</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>Billing_Subscription__c</objectType>
    </variables>
    <variables>
        <name>varOpportunityUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
</Flow>
